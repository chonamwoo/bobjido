<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë§›ì§‘ ì €ì¥ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
            margin-bottom: 30px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
            transition: transform 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
        }
        .success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        .error {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        .warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        .data-display {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            border: 1px solid #e5e7eb;
            max-height: 400px;
            overflow-y: auto;
        }
        pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .restaurant-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .restaurant-info {
            flex: 1;
        }
        .restaurant-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        .restaurant-category {
            color: #666;
            font-size: 14px;
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 8px;
            font-weight: bold;
        }
        .test-result.pass {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .test-result.fail {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ½ï¸ ë§›ì§‘ ì €ì¥ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ ì„¼í„°</h1>
        
        <!-- í˜„ì¬ ì €ì¥ëœ ë°ì´í„° í‘œì‹œ -->
        <div class="test-section">
            <h2>ğŸ“Š í˜„ì¬ ì €ì¥ëœ ë°ì´í„°</h2>
            <button onclick="loadCurrentData()">ë°ì´í„° ìƒˆë¡œê³ ì¹¨</button>
            <button onclick="clearAllData()" class="error">ëª¨ë“  ë°ì´í„° ì‚­ì œ</button>
            <div id="current-data" class="data-display">
                <pre>ë°ì´í„°ë¥¼ ë¡œë“œí•˜ë ¤ë©´ 'ë°ì´í„° ìƒˆë¡œê³ ì¹¨' ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</pre>
            </div>
        </div>

        <!-- ë§›ì§‘ ì €ì¥ í…ŒìŠ¤íŠ¸ -->
        <div class="test-section">
            <h2>ğŸª ë§›ì§‘ ì €ì¥ í…ŒìŠ¤íŠ¸</h2>
            <button onclick="saveTestRestaurant()">í…ŒìŠ¤íŠ¸ ë§›ì§‘ ì €ì¥</button>
            <button onclick="saveMultipleRestaurants()">ì—¬ëŸ¬ ë§›ì§‘ í•œë²ˆì— ì €ì¥</button>
            <button onclick="testDuplicateSave()" class="warning">ì¤‘ë³µ ì €ì¥ í…ŒìŠ¤íŠ¸</button>
            <div id="save-result" class="data-display" style="display:none;"></div>
        </div>

        <!-- ì €ì¥ëœ ë§›ì§‘ ëª©ë¡ -->
        <div class="test-section">
            <h2>ğŸ“‹ ì €ì¥ëœ ë§›ì§‘ ëª©ë¡</h2>
            <button onclick="displaySavedRestaurants()">ëª©ë¡ ë³´ê¸°</button>
            <div id="restaurant-list" class="data-display" style="display:none;"></div>
        </div>

        <!-- ìë™í™” í…ŒìŠ¤íŠ¸ -->
        <div class="test-section">
            <h2>ğŸ¤– ìë™í™” í…ŒìŠ¤íŠ¸</h2>
            <button onclick="runAllTests()" class="success">ëª¨ë“  í…ŒìŠ¤íŠ¸ ì‹¤í–‰</button>
            <div id="test-results" class="data-display" style="display:none;"></div>
        </div>
    </div>

    <script>
        // ë°ì´í„° ê´€ë¦¬ í•¨ìˆ˜ë“¤
        function getSavedRestaurants() {
            const data = localStorage.getItem('bobmap_user_data');
            if (data) {
                const parsed = JSON.parse(data);
                return parsed.savedRestaurants || [];
            }
            return [];
        }

        function saveRestaurant(restaurantId, restaurantData) {
            const data = localStorage.getItem('bobmap_user_data');
            const userData = data ? JSON.parse(data) : { savedRestaurants: [], savedPlaylists: [] };
            
            if (!userData.savedRestaurants) {
                userData.savedRestaurants = [];
            }
            
            // ì¤‘ë³µ ì²´í¬
            const existing = userData.savedRestaurants.find(r => r.restaurantId === restaurantId);
            if (!existing) {
                userData.savedRestaurants.push({
                    restaurantId: restaurantId,
                    savedAt: new Date().toISOString(),
                    notes: ''
                });
                
                // localRestaurantsì—ë„ ì €ì¥
                const localRestaurants = localStorage.getItem('localRestaurants');
                const restaurants = localRestaurants ? JSON.parse(localRestaurants) : [];
                if (!restaurants.find(r => r._id === restaurantId)) {
                    restaurants.push(restaurantData);
                    localStorage.setItem('localRestaurants', JSON.stringify(restaurants));
                }
                
                localStorage.setItem('bobmap_user_data', JSON.stringify(userData));
                
                // ì´ë²¤íŠ¸ ë°œìƒ
                window.dispatchEvent(new CustomEvent('dataManager:update'));
                window.dispatchEvent(new StorageEvent('storage', {
                    key: 'bobmap_user_data',
                    newValue: JSON.stringify(userData),
                    url: window.location.href
                }));
                
                return true;
            }
            return false;
        }

        // UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜ë“¤
        function loadCurrentData() {
            const savedRestaurants = getSavedRestaurants();
            const localRestaurants = localStorage.getItem('localRestaurants');
            const restaurants = localRestaurants ? JSON.parse(localRestaurants) : [];
            
            const display = document.getElementById('current-data');
            display.innerHTML = `<pre>
<strong>ì €ì¥ëœ ë§›ì§‘ ìˆ˜:</strong> ${savedRestaurants.length}ê°œ
<strong>ë¡œì»¬ ë§›ì§‘ ë°ì´í„°:</strong> ${restaurants.length}ê°œ

<strong>ì €ì¥ëœ ë§›ì§‘ ID ëª©ë¡:</strong>
${savedRestaurants.map(r => `- ${r.restaurantId} (${new Date(r.savedAt).toLocaleString()})`).join('\n') || 'ì—†ìŒ'}

<strong>ì „ì²´ ë°ì´í„°:</strong>
${JSON.stringify({ savedRestaurants, localRestaurants: restaurants }, null, 2)}
</pre>`;
        }

        function clearAllData() {
            if (confirm('ì •ë§ë¡œ ëª¨ë“  ì €ì¥ëœ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                const userData = { savedRestaurants: [], savedPlaylists: [] };
                localStorage.setItem('bobmap_user_data', JSON.stringify(userData));
                localStorage.removeItem('localRestaurants');
                
                window.dispatchEvent(new CustomEvent('dataManager:update'));
                alert('ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                loadCurrentData();
            }
        }

        function saveTestRestaurant() {
            const testRestaurant = {
                _id: 'test_' + Date.now(),
                name: 'í…ŒìŠ¤íŠ¸ ë§›ì§‘ ' + new Date().toLocaleTimeString(),
                category: 'í•œì‹',
                address: 'ì„œìš¸ì‹œ ê°•ë‚¨êµ¬ í…ŒìŠ¤íŠ¸ë¡œ 123',
                rating: 4.5,
                image: 'https://source.unsplash.com/400x300/?korean,food'
            };
            
            const success = saveRestaurant(testRestaurant._id, testRestaurant);
            
            const resultDiv = document.getElementById('save-result');
            resultDiv.style.display = 'block';
            if (success) {
                resultDiv.innerHTML = `<div class="test-result pass">âœ… ë§›ì§‘ ì €ì¥ ì„±ê³µ: ${testRestaurant.name}</div>`;
            } else {
                resultDiv.innerHTML = `<div class="test-result fail">âŒ ë§›ì§‘ì´ ì´ë¯¸ ì €ì¥ë˜ì–´ ìˆìŠµë‹ˆë‹¤: ${testRestaurant.name}</div>`;
            }
            
            loadCurrentData();
        }

        function saveMultipleRestaurants() {
            const restaurants = [
                { _id: 'multi_1', name: 'ê¹€ë°¥ì²œêµ­', category: 'ë¶„ì‹', address: 'ì„œìš¸ì‹œ ì¢…ë¡œêµ¬' },
                { _id: 'multi_2', name: 'ìŠ¤ì‹œí•˜ë‚˜', category: 'ì¼ì‹', address: 'ì„œìš¸ì‹œ ê°•ë‚¨êµ¬' },
                { _id: 'multi_3', name: 'íŒŒìŠ¤íƒ€ì§‘', category: 'ì–‘ì‹', address: 'ì„œìš¸ì‹œ ë§ˆí¬êµ¬' }
            ];
            
            let successCount = 0;
            restaurants.forEach(r => {
                if (saveRestaurant(r._id, r)) {
                    successCount++;
                }
            });
            
            const resultDiv = document.getElementById('save-result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `<div class="test-result pass">âœ… ${successCount}ê°œ ë§›ì§‘ ì €ì¥ ì™„ë£Œ</div>`;
            
            loadCurrentData();
        }

        function testDuplicateSave() {
            const testRestaurant = {
                _id: 'duplicate_test',
                name: 'ì¤‘ë³µ í…ŒìŠ¤íŠ¸ ë§›ì§‘',
                category: 'ì¤‘ì‹',
                address: 'ì„œìš¸ì‹œ ì¤‘êµ¬'
            };
            
            const first = saveRestaurant(testRestaurant._id, testRestaurant);
            const second = saveRestaurant(testRestaurant._id, testRestaurant);
            
            const resultDiv = document.getElementById('save-result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `
                <div class="test-result ${first ? 'pass' : 'fail'}">ì²« ë²ˆì§¸ ì €ì¥: ${first ? 'âœ… ì„±ê³µ' : 'âŒ ì‹¤íŒ¨'}</div>
                <div class="test-result ${!second ? 'pass' : 'fail'}">ë‘ ë²ˆì§¸ ì €ì¥ (ì¤‘ë³µ): ${!second ? 'âœ… ì •ìƒì ìœ¼ë¡œ ì°¨ë‹¨ë¨' : 'âŒ ì¤‘ë³µ ì €ì¥ë¨ (ì˜¤ë¥˜)'}</div>
            `;
            
            loadCurrentData();
        }

        function displaySavedRestaurants() {
            const savedRestaurants = getSavedRestaurants();
            const localRestaurants = localStorage.getItem('localRestaurants');
            const restaurants = localRestaurants ? JSON.parse(localRestaurants) : [];
            
            const listDiv = document.getElementById('restaurant-list');
            listDiv.style.display = 'block';
            
            if (savedRestaurants.length === 0) {
                listDiv.innerHTML = '<p>ì €ì¥ëœ ë§›ì§‘ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            
            let html = '';
            savedRestaurants.forEach(saved => {
                const restaurant = restaurants.find(r => r._id === saved.restaurantId);
                html += `
                    <div class="restaurant-card">
                        <div class="restaurant-info">
                            <div class="restaurant-name">${restaurant?.name || saved.restaurantId}</div>
                            <div class="restaurant-category">${restaurant?.category || 'ì •ë³´ ì—†ìŒ'} | ${restaurant?.address || 'ì£¼ì†Œ ì—†ìŒ'}</div>
                            <div style="color: #999; font-size: 12px; margin-top: 5px;">ì €ì¥ì¼: ${new Date(saved.savedAt).toLocaleString()}</div>
                        </div>
                        <button onclick="removeRestaurant('${saved.restaurantId}')" class="error">ì‚­ì œ</button>
                    </div>
                `;
            });
            
            listDiv.innerHTML = html;
        }

        function removeRestaurant(restaurantId) {
            const data = localStorage.getItem('bobmap_user_data');
            const userData = data ? JSON.parse(data) : { savedRestaurants: [], savedPlaylists: [] };
            
            userData.savedRestaurants = userData.savedRestaurants.filter(r => r.restaurantId !== restaurantId);
            localStorage.setItem('bobmap_user_data', JSON.stringify(userData));
            
            window.dispatchEvent(new CustomEvent('dataManager:update'));
            
            displaySavedRestaurants();
            loadCurrentData();
        }

        function runAllTests() {
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = '<h3>í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘...</h3>';
            
            const tests = [];
            
            // Test 1: ì €ì¥ ê¸°ëŠ¥
            const testId1 = 'auto_test_' + Date.now();
            const testData1 = { _id: testId1, name: 'ìë™ í…ŒìŠ¤íŠ¸ ë§›ì§‘ 1', category: 'í…ŒìŠ¤íŠ¸' };
            const saveResult = saveRestaurant(testId1, testData1);
            tests.push({
                name: 'ë§›ì§‘ ì €ì¥ ê¸°ëŠ¥',
                passed: saveResult === true,
                message: saveResult ? 'ì •ìƒ ì‘ë™' : 'ì €ì¥ ì‹¤íŒ¨'
            });
            
            // Test 2: ì¤‘ë³µ ë°©ì§€
            const duplicateResult = saveRestaurant(testId1, testData1);
            tests.push({
                name: 'ì¤‘ë³µ ì €ì¥ ë°©ì§€',
                passed: duplicateResult === false,
                message: duplicateResult === false ? 'ì¤‘ë³µ ë°©ì§€ ì •ìƒ ì‘ë™' : 'ì¤‘ë³µ ì €ì¥ë¨ (ì˜¤ë¥˜)'
            });
            
            // Test 3: ë°ì´í„° ì¡°íšŒ
            const savedData = getSavedRestaurants();
            const found = savedData.find(r => r.restaurantId === testId1);
            tests.push({
                name: 'ì €ì¥ëœ ë°ì´í„° ì¡°íšŒ',
                passed: !!found,
                message: found ? 'ë°ì´í„° ì¡°íšŒ ì„±ê³µ' : 'ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨'
            });
            
            // Test 4: ë¡œì»¬ ë ˆìŠ¤í† ë‘ ë°ì´í„°
            const localRestaurants = localStorage.getItem('localRestaurants');
            const restaurants = localRestaurants ? JSON.parse(localRestaurants) : [];
            const localFound = restaurants.find(r => r._id === testId1);
            tests.push({
                name: 'ë¡œì»¬ ë§›ì§‘ ë°ì´í„° ì €ì¥',
                passed: !!localFound,
                message: localFound ? 'ë¡œì»¬ ë°ì´í„° ì €ì¥ ì„±ê³µ' : 'ë¡œì»¬ ë°ì´í„° ì €ì¥ ì‹¤íŒ¨'
            });
            
            // ê²°ê³¼ í‘œì‹œ
            let html = '<h3>í…ŒìŠ¤íŠ¸ ê²°ê³¼</h3>';
            let passedCount = 0;
            
            tests.forEach((test, index) => {
                if (test.passed) passedCount++;
                html += `
                    <div class="test-result ${test.passed ? 'pass' : 'fail'}">
                        ${index + 1}. ${test.name}: ${test.passed ? 'âœ… PASS' : 'âŒ FAIL'} - ${test.message}
                    </div>
                `;
            });
            
            html = `
                <div style="font-size: 20px; font-weight: bold; margin-bottom: 20px; color: ${passedCount === tests.length ? '#10b981' : '#ef4444'};">
                    ì´ ${tests.length}ê°œ í…ŒìŠ¤íŠ¸ ì¤‘ ${passedCount}ê°œ í†µê³¼
                </div>
            ` + html;
            
            resultsDiv.innerHTML = html;
            
            // í…ŒìŠ¤íŠ¸ í›„ ë°ì´í„° ìƒˆë¡œê³ ì¹¨
            loadCurrentData();
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° í‘œì‹œ
        window.onload = function() {
            loadCurrentData();
        };
    </script>
</body>
</html>